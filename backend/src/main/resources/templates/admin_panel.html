<!DOCTYPE html>
<html lang="tr" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Kullanıcı Yetki Yönetimi • Metal Ürünler Kayıt Programı</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css"/>
    <link rel="stylesheet" href="/css/admin.css"/>

    <!-- CSRF -->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">

    <style>
        body { background:#f4f6f9 }
        .container-narrow { max-width:1100px; margin:40px auto }
        .block{ background:#fff; border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,.08); padding:24px }
        .page-title{ font-weight:700 }
        .role-badge{ font-size:.85rem; color:#fff; padding:.25rem .5rem; border-radius:.5rem }
        .role-badge.ADMIN{ background:#dc3545 }
        .role-badge.OPERATOR{ background:#0d6efd }
        .role-badge.USER{ background:#6c757d }
        .actions{ display:flex; gap:.5rem; flex-wrap:wrap }
        .btn-sm{
            display: inline-flex;          /* içerik için flex */
            align-items: center;           /* dikey ortala */
            gap: .35rem;                   /* ikon/metin arası */
            line-height: 1.2;              /* satır taşmasını azalt */
            padding: .25rem .5rem;         /* küçük ve sıkı */
        }

        /* Bootstrap Icons default vertical-align’ı sıfırla */
        .btn-sm .bi{
            vertical-align: 0;             /* -.125em kuralını geçersiz kılar */
            line-height: 1;                /* ikonun satır kutusunu küçült */
        }

        .btn-sm .bi{
            position: relative;
            top: .03rem;                   /* .02–.06rem arası oynatabilirsin */
        }
    </style>
</head>
<body>
<div class="container container-narrow">
    <div class="block">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="page-title h4 m-0"><i class="bi bi-shield-lock"></i> Kullanıcı Yetki Yönetimi</h1>
            <a href="/" class="btn btn-outline-secondary btn-sm"><i class="bi bi-house"></i> Ana Sayfa</a>
        </div>

        <p class="text-muted mb-4">Bu sayfaya yalnızca <b>ADMIN</b> rolüne sahip kullanıcılar erişebilir.</p>

        <!-- Flash -->
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <div class="table-responsive">
            <table id="usersTable" class="table table-striped align-middle">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Kullanıcı Adı</th>
                    <th>Ad Soyad</th>
                    <th>Departman</th>
                    <th>Mevcut Rol</th>
                    <th>Yeni Rol</th>
                    <th style="width:220px">İşlem</th>
                </tr>
                </thead>
                <tbody>
                <!-- Kayıtlar -->
                <th:block th:each="u : ${users}">
                    <tr th:if="${u != null}">
                        <td th:text="${u.id}">1</td>
                        <td th:text="${u.username}">jsmith</td>
                        <td th:text="${u.fullName == null || #strings.isEmpty(u.fullName) ? '-' : u.fullName}">Ad Soyad</td>
                        <td th:text="${u.department == null || #strings.isEmpty(u.department) ? '-' : u.department}">Departman</td>
                        <td>
              <span class="role-badge"
                    th:text="${u.permission == null || #strings.isEmpty(u.permission) ? 'USER' : u.permission}"
                    th:classappend="${u.permission == null || #strings.isEmpty(u.permission) ? 'USER' : u.permission}">
                USER
              </span>
                            <!-- Yeni Rol sütunu -->
                        <td>
                            <div th:if="${u.id != null}">
                                <form th:id="'roleForm' + ${u.id}"
                                      th:action="@{/admin/users/{id}/role(id=${u.id})}"
                                      method="post">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <select class="form-select form-select-sm" name="permission" required>
                                        <option value="USER"
                                                th:selected="${u.permission == null || #strings.isEmpty(u.permission) ? true : (u.permission=='USER')}">
                                            USER
                                        </option>
                                        <option value="OPERATOR" th:selected="${u.permission=='OPERATOR'}">OPERATOR</option>
                                        <option value="ADMIN" th:selected="${u.permission=='ADMIN'}">ADMIN</option>
                                    </select>
                                </form>
                            </div>
                        </td>

                        <!-- İşlem sütunu -->
                        <td>
                            <div class="actions d-flex gap-2" th:if="${u.id != null}">
                                <!-- Kaydet butonu: Yukarıdaki form ile bağlı -->
                                <button type="submit"
                                        th:form="'roleForm' + ${u.id}"
                                        class="btn btn-sm btn-primary">
                                    <i class="bi bi-save"></i> Kaydet
                                </button>

                                <!-- Sil butonu -->
                                <form th:action="@{/admin/users/{id}/delete(id=${u.id})}" method="post"
                                      onsubmit="return confirm('Bu kullanıcıyı silmek istediğinize emin misiniz?');">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i> Sil
                                    </button>
                                </form>
                            </div>
                        </td>

                    </tr>
                </th:block>

                <!-- Hiç kayıt yoksa -->
                <tr th:if="${users == null or #lists.isEmpty(users)}">
                    <td colspan="7" class="text-center text-muted">Kayıt bulunamadı.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script th:inline="none">
    $(function () {
        try {
            $('#usersTable').DataTable({
                pageLength: 10,
                order: [[0, 'asc']],
                language: { url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/tr.json' },
                autowidth: true
            });
        } catch (e) {
            console.warn('DataTables yüklenemedi:', e);
        }
    });

</script>
</body>
</html>
